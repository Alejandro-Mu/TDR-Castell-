<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptari Culinari Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .btn-hover:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .search-bar-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        .recipe-card {
            transition: transform 0.2s, box-shadow 0.2s;
            color: var(--card-text-color, #333);
        }
        .recipe-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        .chatbot-window {
            width: 350px;
            height: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .chat-header {
            background-color: #3f3f46;
            color: white;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
            padding: 1rem;
        }
        .user-message {
            background-color: #eef2ff;
            color: #312e81;
            align-self: flex-end;
            max-width: 80%;
        }
        .bot-message {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            max-width: 80%;
        }
        .modal-content-wrapper {
            max-width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }
        .header-image {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 50%;
            border: 6px solid #F0C419;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            background-color: #e5e7eb;
        }
        .header-title-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
            margin-top: 20px;
            gap: 40px;
        }
        .filter-btn {
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 1px solid;
            color: #1f2937;
        }
        .filter-btn:hover {
            opacity: 1;
            filter: brightness(0.95);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="text-center mb-10">
        <div class="header-title-container">
            <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=180&h=180&auto=format&fit=crop" alt="Amanida i Pollastre" class="header-image hidden sm:block">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-2">Receptari Culinari Digital</h1>
            <img src="https://cdn.pixabay.com/photo/2017/09/30/15/10/plate-2802332_1280.jpg" alt="Ramen/Fideus" class="header-image hidden sm:block">
        </div>
        <p class="text-xl text-gray-500">La teva col·lecció de plats.</p>
    </header>
   
    <div id="connection-status" class="text-center mb-6">
        <span id="user-id-display" class="inline-flex items-center px-3 py-1 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-full">
            <i data-lucide="user" class="w-4 h-4 mr-1"></i> Carregant usuari...
        </span>
    </div>
   
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
        <div class="lg:col-span-3">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-3">
                <div class="relative w-full sm:w-80">
                    <input type="text" id="search-input" placeholder="Cerca per nom..." class="search-bar-input w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none" />
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button id="view-list-btn" class="btn-hover px-4 py-3 rounded-xl font-semibold transition duration-150 w-full sm:w-auto bg-indigo-600 text-white shadow-md">
                        <i data-lucide="list-ordered" class="w-5 h-5 inline-block mr-1"></i> Llista
                    </button>
                    <button id="view-add-btn" class="btn-hover px-4 py-3 rounded-xl font-semibold transition duration-150 w-full sm:w-auto bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i data-lucide="plus-circle" class="w-5 h-5 inline-block mr-1"></i> Afegir
                    </button>
                </div>
            </div>
       
            <div id="filter-buttons" class="flex flex-wrap gap-2 mb-6"></div>

            <div id="recipe-list-view">
                <div id="recipes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-recipes-message" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-yellow-700 mt-6">
                    <p class="font-bold">No s'han trobat receptes.</p>
                    <p>Prova d'ajustar la teva cerca o filtre.</p>
                </div>
                <div id="loading-message" class="text-center py-10 text-gray-500 text-xl flex justify-center items-center">
                    <i data-lucide="loader" class="w-8 h-8 animate-spin mr-3"></i> Carregant receptes...
                </div>
            </div>
       
            <div id="add-recipe-view" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-100 max-w-2xl mx-auto">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Afegir Nova Recepta</h2>
                <form id="add-recipe-form">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="nom">Nom de la Recepta</label>
                        <input id="nom" name="nombre" type="text" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"/>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="categoria">País / Origen Culinari</label>
                        <select id="categoria" name="categoria" required class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl">
                            <option value="mexic">Mèxic</option>
                            <option value="peru">Perú</option>
                            <option value="españa">Espanya</option>
                            <option value="argentina">Argentina</option>
                            <option value="colombia">Colòmbia</option>
                            <option value="chile">Xile</option>
                            <option value="venezuela">Veneçuela</option>
                            <option value="ecuador">Equador</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="ingredients">Ingredients</label>
                        <textarea id="ingredients" name="ingredientes" required rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="passos">Passos (Instruccions)</label>
                        <textarea id="passos" name="pasos" required rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="imatge_url">URL Imatge (Opcional)</label>
                        <input id="imatge_url" name="imagen_url" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-xl"/>
                    </div>
                    <button type="submit" id="save-recipe-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl focus:outline-none focus:shadow-outline transition duration-150 btn-hover flex items-center justify-center text-lg mt-4" disabled>
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i> Guardar Recepta
                    </button>
                </form>
            </div>

            <div id="recipe-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 relative my-10 transform scale-95 transition-all duration-300 modal-content-wrapper">
                    <button id="close-detail-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition duration-150 z-10">
                        <i data-lucide="x" class="w-8 h-8"></i>
                    </button>
                    <div id="modal-content"></div>
                </div>
            </div>

            <div id="floating-message-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50"></div>
        </div>
    </div>
   
    <div class="fixed bottom-6 right-6 z-50">
        <button id="chatbot-toggle-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition duration-300 btn-hover">
            <i data-lucide="message-square" class="w-7 h-7"></i>
        </button>
        <div id="chatbot-window" class="chatbot-window hidden absolute bottom-16 right-0 rounded-xl border border-gray-200 bg-white">
            <div class="chat-header p-3 flex justify-between items-center rounded-t-xl">
                <span class="font-bold text-lg flex items-center">
                    <i data-lucide="chef-hat" class="w-5 h-5 mr-2"></i> Assistent
                </span>
                <button id="chatbot-close-btn" class="text-white opacity-75 hover:opacity-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="chat-messages" class="chat-messages space-y-3">
                <div class="bot-message p-3 rounded-xl shadow-sm text-sm">Hola! Puc ajudar-te amb les receptes. Què vols fer?</div>
            </div>
            <form id="chat-form" class="p-3 border-t border-gray-200 bg-white">
                <div class="flex">
                    <input type="text" id="chat-input" placeholder="Escriu..." class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
                    <button type="submit" id="chat-send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-r-lg transition duration-150 flex items-center justify-center">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let allRecipes = [];
        let currentFilter = 'all';

        const CATEGORY_MAP = { "mexic": "Mèxic", "peru": "Perú", "españa": "Espanya", "argentina": "Argentina", "colombia": "Colòmbia", "chile": "Xile", "venezuela": "Veneçuela", "ecuador": "Equador" };
        const CATEGORY_COLORS = {
            "mexic": { bg: "#77A8A8", text: "#FFFFFF", light: "#D7E9E9", text_dark: "#333" },
            "peru": { bg: "#E8A375", text: "#333333", light: "#F8E4D7", text_dark: "#333" },
            "españa": { bg: "#C9898E", text: "#FFFFFF", light: "#F2DDE0", text_dark: "#333" },
            "argentina": { bg: "#AEC59D", text: "#333333", light: "#E9F0E5", text_dark: "#333" },
            "colombia": { bg: "#A59CC4", text: "#FFFFFF", light: "#EBE9F4", text_dark: "#333" },
            "chile": { bg: "#5A9A77", text: "#FFFFFF", light: "#D6E4DB", text_dark: "#333" },
            "venezuela": { bg: "#F0C419", text: "#333333", light: "#FCEFD2", text_dark: "#333" },
            "ecuador": { bg: "#6E8898", text: "#FFFFFF", light: "#DCE3E8", text_dark: "#333" },
            "all": { bg: "#4f46e5", text: "#FFFFFF", light: "#E8E7FA", text_dark: "#333" }
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').innerHTML = `<i data-lucide="user" class="w-4 h-4 mr-1"></i> Usuari ID: ${userId}`;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        document.getElementById('save-recipe-btn').disabled = false;
                        listenForRecipes();
                    } else {
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    }
                });
            } catch (error) { console.error("Error Firebase:", error); }
        }

        function getRecipesCollectionRef() {
            if (!userId || !db) return null;
            return collection(db, 'artifacts', appId, 'users', userId, 'receptes');
        }

        function listenForRecipes() {
            const collectionRef = getRecipesCollectionRef();
            if (!collectionRef) return;
            onSnapshot(query(collectionRef), (snapshot) => {});
        }

        async function loadRecipesFromFlask() {
            document.getElementById('loading-message').classList.remove('hidden');
            try {
                const response = await fetch('/api/recipes?cat=' + currentFilter);
                const recipes = await response.json();
                allRecipes = recipes.map(r => ({
                    ...r,
                    categoria: r.categoria_interna || r.categoria || 'altres',
                    nom: r.nombre || r.nom,
                    ingredients: r.ingredientes || r.ingredients,
                    passos: r.pasos || r.passos,
                    imatge_url: r.url
                }));
                allRecipes.sort((a, b) => (a.nom || '').localeCompare((b.nom || ''), 'ca'));
                filterAndRenderRecipes(document.getElementById('search-input').value.toLowerCase().trim());
            } catch (error) { console.error("Error Flask:", error); }
            finally { document.getElementById('loading-message').classList.add('hidden'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            setupEventListeners();
            renderFilterButtons();
            loadRecipesFromFlask();
            setupChatbot();
        });

        function setupEventListeners() {
            document.getElementById('view-list-btn').addEventListener('click', () => switchView('list'));
            document.getElementById('view-add-btn').addEventListener('click', () => switchView('add'));
            document.getElementById('add-recipe-form').addEventListener('submit', handleAddRecipe);
            document.getElementById('search-input').addEventListener('input', (e) => filterAndRenderRecipes(e.target.value.toLowerCase().trim()));
            document.getElementById('close-detail-modal').addEventListener('click', closeRecipeDetailModal);
        }

        function closeRecipeDetailModal() {
            document.getElementById('recipe-detail-modal').classList.add('hidden');
            document.getElementById('recipe-detail-modal').classList.remove('flex');
        }

        function switchView(view) {
            const listBtn = document.getElementById('view-list-btn');
            const addBtn = document.getElementById('view-add-btn');
            if (view === 'list') {
                document.getElementById('recipe-list-view').classList.remove('hidden');
                document.getElementById('add-recipe-view').classList.add('hidden');
                listBtn.classList.add('bg-indigo-600', 'text-white');
                addBtn.classList.remove('bg-indigo-600', 'text-white');
            } else {
                document.getElementById('recipe-list-view').classList.add('hidden');
                document.getElementById('add-recipe-view').classList.remove('hidden');
                addBtn.classList.add('bg-indigo-600', 'text-white');
                listBtn.classList.remove('bg-indigo-600', 'text-white');
            }
        }

        function renderFilterButtons() {
            const container = document.getElementById('filter-buttons');
            container.innerHTML = '';
            container.appendChild(createFilterButton('all', 'Totes'));
            Object.entries(CATEGORY_MAP).forEach(([key, value]) => container.appendChild(createFilterButton(key, value)));
        }

        function createFilterButton(key, text) {
            const button = document.createElement('button');
            const colorPalette = CATEGORY_COLORS[key] || CATEGORY_COLORS['all'];
            button.className = 'filter-btn px-4 py-2 rounded-full text-sm font-semibold transition border';
            button.style.backgroundColor = (key === currentFilter) ? colorPalette.bg : colorPalette.light;
            button.style.color = (key === currentFilter) ? colorPalette.text : colorPalette.text_dark;
            button.textContent = text;
            button.addEventListener('click', () => {
                currentFilter = key;
                renderFilterButtons();
                filterAndRenderRecipes(document.getElementById('search-input').value.toLowerCase().trim());
            });
            return button;
        }

        function filterAndRenderRecipes(searchTerm) {
            const filtered = allRecipes.filter(r => (r.nom || '').toLowerCase().includes(searchTerm) && (currentFilter === 'all' || r.categoria === currentFilter));
            renderRecipes(filtered);
        }

        function renderRecipes(recipes) {
            const container = document.getElementById('recipes-container');
            container.innerHTML = '';
            if (recipes.length === 0) { document.getElementById('no-recipes-message').classList.remove('hidden'); return; }
            document.getElementById('no-recipes-message').classList.add('hidden');
            recipes.forEach(r => container.appendChild(createRecipeCard(r)));
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        const cleanText = (text) => {
            if (!text) return '';
            let cleaned = text.replace(/^\[['"]?|['"]?\]$/g, '');
            cleaned = cleaned.replace(/['"]?, ?['"]?/g, ' ');
            return cleaned.trim();
        };

        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            const color = CATEGORY_COLORS[recipe.categoria]?.bg || '#6b7280';
            const textColor = CATEGORY_COLORS[recipe.categoria]?.text || '#FFFFFF';
            card.className = 'recipe-card rounded-xl shadow-lg overflow-hidden cursor-pointer p-5 flex flex-col justify-between h-48';
            card.style.backgroundColor = color;
            card.style.color = textColor;
           
            // Netegem els ingredients per a la previsualització (sense salts de línia estranys)
            const previewText = cleanText(recipe.ingredients).replace(/\n/g, ' ').substring(0, 75);

            card.innerHTML = `
                <div>
                    <h3 class="text-2xl font-bold mb-2 truncate">${recipe.nom}</h3>
                    <p class="text-sm opacity-90 line-clamp-3 leading-snug">
                        ${previewText}${previewText.length >= 75 ? '...' : ''}
                    </p>
                </div>
                <div class="flex justify-end items-center mt-2 opacity-80 text-xs font-semibold uppercase tracking-wider">
                    Veure recepta <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                </div>
            `;
            card.addEventListener('click', () => showRecipeDetail(recipe));
            return card;
        }

        window.showRecipeDetail = function(recipe) {
            const modal = document.getElementById('recipe-detail-modal');
            const content = document.getElementById('modal-content');
            const color = CATEGORY_COLORS[recipe.categoria]?.bg || '#6b7280';

            const toHtmlList = (text, isIngredient = false) => {
                const cleanedText = cleanText(text);
                if (!cleanedText) return '<ul><li>No hi ha dades.</li></ul>';
               
                let items = [];
                if (isIngredient) {
                    items = cleanedText.split(/(?=\d)/).filter(i => i.trim().length > 1);
                } else {
                    items = cleanedText.split(/[\r\n]+|(?<!\d)\.(?!\d)\s*/).filter(i => i.trim().length > 1);
                }
               
                const listItems = items.map(item => `
                    <li class="mb-2 text-gray-700 flex items-start">
                        <i data-lucide="check" class="w-5 h-5 mr-2 flex-shrink-0 mt-1" style="color: ${color};"></i>
                        ${item.trim()}
                    </li>`).join('');
                return `<ul class="list-none space-y-2">${listItems}</ul>`;
            };

            content.innerHTML = `
                <h1 class="text-3xl font-extrabold mb-4">${recipe.nom}</h1>
                <div class="space-y-6">
                    <div>
                        <h2 class="text-xl font-bold border-b-2 mb-3" style="border-color: ${color}">Ingredients</h2>
                        ${toHtmlList(recipe.ingredients, true)}
                    </div>
                    <div>
                        <h2 class="text-xl font-bold border-b-2 mb-3" style="border-color: ${color}">Passos de Preparació</h2>
                        ${toHtmlList(recipe.passos, false)}
                    </div>
                </div>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        async function handleAddRecipe(e) {
            e.preventDefault();
            const btn = document.getElementById('save-recipe-btn');
            btn.disabled = true;
            const form = e.target;
            const newRecipe = {
                nom: form.nom.value.trim(),
                categoria: form.categoria.value,
                ingredients: form.ingredients.value.trim(),
                passos: form.passos.value.trim(),
                imatge_url: form.imatge_url.value.trim(),
                createdAt: new Date().toISOString()
            };
            try {
                const ref = getRecipesCollectionRef();
                if (ref) await addDoc(ref, newRecipe);
                showFloatingMessage('Guardat!', 'success');
                form.reset();
                switchView('list');
            } catch (err) { showFloatingMessage('Error', 'error'); }
            finally { btn.disabled = false; }
        }

        function showFloatingMessage(message, type) {
            const container = document.getElementById('floating-message-container');
            const msgEl = document.createElement('div');
            msgEl.className = `p-4 rounded-xl shadow-xl mb-3 text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            msgEl.textContent = message;
            container.appendChild(msgEl);
            setTimeout(() => msgEl.remove(), 3000);
        }

        function setupChatbot() {
            document.getElementById('chatbot-toggle-btn').addEventListener('click', () => document.getElementById('chatbot-window').classList.toggle('hidden'));
            document.getElementById('chatbot-close-btn').addEventListener('click', () => document.getElementById('chatbot-window').classList.add('hidden'));
            document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            displayMessage(msg, 'user');
            input.value = '';
            try {
                const res = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                displayMessage(data.response, 'bot');
                if (data.recipe) {
                    const r = data.recipe;
                    window.showRecipeDetail({
                        nom: r.nombre || r.nom,
                        categoria: r.categoria_interna || r.categoria || 'all',
                        ingredients: r.ingredientes || r.ingredients,
                        passos: r.pasos || r.passos
                    });
                }
            } catch (err) { displayMessage("Error", 'bot'); }
        }

        function displayMessage(message, sender) {
            const container = document.getElementById('chat-messages');
            const el = document.createElement('div');
            el.className = `p-3 rounded-xl text-sm ${sender === 'user' ? 'user-message ml-auto' : 'bot-message mr-auto'}`;
            el.innerHTML = message.replace(/\n/g, '<br>');
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>

